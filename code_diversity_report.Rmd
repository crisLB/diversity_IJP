---
title: Code for reproducibility of "Assembly rules of helminth parasite communities in grey mullets: combining components of diversity"
author: "Cristina Llopis-Belenguer, Sandrine Pavoine, Isabel Blasco-Costa, Juan Antonio Balbuena"
output:
  html_document:
    fig_caption: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, fig.width = 15, fig.align = "center")
```

# Libraries
Load the libraries required.
```{r}
library(vegan)
library(ade4)
library(adiv)
library(adegraphics)
library(RRPP)
```

# Data
## Set a working directory
This is an optional step. Researchers could be interested in saving data and results in the same folder, the working directory. If data is stored in the working directory they will call data everytime with the name of the file and it will not be necssary to write the path to a file anymore. 
```{r}
setwd("C:/Users/Cristina/Documents/diversity_code")
```

## Databases Case 1
### Host-parasite abundance data
We upload the host-parasite abundance matrix. We subtset this matrix to perform the analysis of the Case study 1 (see main text). Case 1 includes parasite species of _Chelon auratus_, _Chelon ramada_ and _Mugil cephalus_ from Santa Pola Sea (SPS) autumn 2004 (2) and autumn 2005 (4).
```{r}
host<- read.delim("diversity_data.txt", row.names = 1)
host1<- host[host$case<= 1,]
h1data<-host1[,1:5] # host info
h1data<- cbind(h1data, struc=as.factor(rep(c("2CSPS", "4CSPS", "2ASPS", "4ASPS", "2RSPS", "4RSPS"), c(20, 30, 12, 30, 30, 15))))
host1<-host1[apply(host1[,6:ncol(host1)], 1, sum)>0,-(1:5)] # host1[remove host without parasites, remove host information]
host1<-host1[,apply(host1, 2, sum)>0] # remove parasite species that are not present in this Case study
```

### Parasite functional trait data
We upload the functional trait information of all the parasite species in the sample. Then, we log-transformed numerical traits.
```{r}
traits<- read.delim("traits_total.txt", row.names = 1)
traits$Esiz<-log(traits$Esiz+1)
traits$Enum<-log(traits$Enum+1)
traits$Bmas<-log(traits$Bmas+1)
```
We subset the parasite species present in Case 1.
```{r}
traits1<- traits[intersect(rownames(traits), colnames(host1)),] # functional traits of parasite species present in Case 1
```
To give the same weight to all traits, we transform each column into a single matrix. Otherwise, a category of a categorical functional trait (e.g. attachment sucker) would have the same weight as a numerical functional trait (e.g. egg size).
```{r}
n_atta1<-data.frame(atta=traits1[,1], row.names = row.names(traits1)) # Give the same weight to all traits
o_esiz1<-data.frame(esiz=traits1[,2], row.names = row.names(traits1))
o_enum1<-data.frame(enum=traits1[,3], row.names = row.names(traits1))
o_bmas1<-data.frame(bmas=traits1[,4], row.names = row.names(traits1))
n_lcyc1<-data.frame(lcyc=traits1[,5], row.names = row.names(traits1))
```
Then, we have to create a ktab object. It is a list of objects, each belonging to the class data.frame (see Supplementary Material in Pavoine et al., 2009, https://doi.org/10.1111/j.1600-0706.2008.16668.x). We calculate Gower distances between parasite species in terms of functional traits. Notice that the type of functional trait must be especified (i.e. O: ordinal; N: nominal) Finally, following Pavoine et al. (2009), we transform the Gower distances into Euclidean distances and rescale them between 0 and 1.
```{r}
ktab1<-ktab.list.df(list(o_esiz1, o_enum1, o_bmas1, n_atta1, n_lcyc1)) 
traits1dist<- dist.ktab(ktab1, c("O", "O", "O", "N", "N")) # Gower distance -> matrix of functional distances
traits1dist<-lingoes(traits1dist) # transform Gower distances into Euclidean ones
traits1dist<-traits1dist/max(traits1dist) # [0,1]
#is.euclid(traits1dist) # this function double-checks that the distance matrix is Euclidean
```
### Parasite proxy of phylogeny
We upload the phylogenetic-like information of all the parasite species in the sample.
```{r}
phylo<- read.delim("phylo_total.txt", row.names = 1)
```
We subset the parasite species present in Case 1.
```{r}
phylo1<- phylo[intersect(rownames(phylo), colnames(host1)),] # phylogenetic-like information of parasite species present in Case 1
phylo1dist<-taxa2dist(phylo1, varstep=TRUE) # matrix of phylogenetic-like distances
phylo1dist<-phylo1dist/max(phylo1dist) #[0,1]
#is.euclid(phylo1dist) # this function double-checks that the distance matrix is Euclidean
```
## Databases Case 1 sample autumn 2004
### Host-parasite abundance data
```{r}
h1data_s2<- as.data.frame.matrix(h1data[c(1:20, 51:62, 93:122),]) # Subset host information from autumn 2004
host1_s2<-host1[c(1:20, 51:62, 93:122),] # Subset community from autumn 2004
host1_s2<-host1_s2[,apply(host1_s2, 2, sum)>0] # remove parasite species that are not present in Case 1 sample autumn 2004
```
### Parasite functional trait data
```{r}
traits1_s2<- traits1[intersect(rownames(traits1), colnames(host1_s2)),] # functional traits of species present in Case 1 autumn 2004
n_atta1s2<-data.frame(atta=traits1_s2[,1], row.names = row.names(traits1_s2)) # give the same weight to all traits
o_esiz1s2<-data.frame(esiz=traits1_s2[,2], row.names = row.names(traits1_s2))
o_enum1s2<-data.frame(enum=traits1_s2[,3], row.names = row.names(traits1_s2))
o_bmas1s2<-data.frame(bmas=traits1_s2[,4], row.names = row.names(traits1_s2))
n_lcyc1s2<-data.frame(lcyc=traits1_s2[,5], row.names = row.names(traits1_s2))
ktab1s2<-ktab.list.df(list(o_esiz1s2, o_enum1s2, o_bmas1s2, n_atta1s2, n_lcyc1s2))
traits1dist_s2<- dist.ktab(ktab1s2, c("O", "O", "O", "N", "N")) # Gower distance
traits1dist_s2<-lingoes(traits1dist_s2) # Euclidean distance
traits1dist_s2<-traits1dist_s2/max(traits1dist_s2) # [0,1]
#is.euclid(phylo1dist_s2)
```
### Parasite proxy of phylogeny
```{r}
phylo1_s2<-phylo1[intersect(row.names(phylo1), colnames(host1_s2)),] # phylogenetic-like information of species present in Case 1 autumn 2004
phylo1dist_s2<-taxa2dist(phylo1_s2, varstep=TRUE)
phylo1dist_s2<-phylo1dist_s2/max(phylo1dist_s2)
#is.euclid(phylo1dist_s2)
```

## Databases Case 1 sample autumn 2005
### Host-parasite abundance data
```{r}
h1data_s4<- as.data.frame.matrix(h1data[c(21:50, 63:92, 123:137),]) # Subset host information from autumn 2005
host1_s4<-host1[c(21:50, 63:92, 123:137),] # Subset community from autumn 2004
host1_s4<-host1_s4[,apply(host1_s4, 2, sum)>0] # remove parasite species that are not present in Case 1 autumn 2005 
```
### Parasite functional trait data
```{r}
traits1_s4<- traits1[intersect(rownames(traits1), colnames(host1_s4)),] # functional traits of species present in Case 1 autumn 2005
n_atta1s4<-data.frame(atta=traits1_s4[,1], row.names = row.names(traits1_s4)) # give the same weight to all traits
o_esiz1s4<-data.frame(esiz=traits1_s4[,2], row.names = row.names(traits1_s4))
o_enum1s4<-data.frame(enum=traits1_s4[,3], row.names = row.names(traits1_s4))
o_bmas1s4<-data.frame(bmas=traits1_s4[,4], row.names = row.names(traits1_s4))
n_lcyc1s4<-data.frame(lcyc=traits1_s4[,5], row.names = row.names(traits1_s4))
ktab1s4<-ktab.list.df(list(o_esiz1s4, o_enum1s4, o_bmas1s4, n_atta1s4, n_lcyc1s4))
traits1dist_s4<- dist.ktab(ktab1s4, c("O", "O", "O", "N", "N")) # Gower distance
traits1dist_s4<-lingoes(traits1dist_s4) # Euclidean distance
traits1dist_s4<-traits1dist_s4/max(traits1dist_s4) # [0,1]
#is.euclid(phylo1dist_s4)
```
### Parasite proxy of phylogeny
```{r}
# Proxy of phylogeney Case 1 sample 4
phylo1_s4<-phylo1[intersect(row.names(phylo1), colnames(host1_s4)),] # phylogenetic-like information of species present in Case 1 autumn 2005
phylo1dist_s4<-taxa2dist(phylo1_s4, varstep=TRUE)
#is.euclid(phylo1dist_s4)
phylo1dist_s4<-phylo1dist_s4/max(phylo1dist_s4)
#is.euclid(phylo1dist_s4)
```

# Diversity analyses
## Influence of one factor on diversity
### α diversity analyses
The dpcoa function is a combined version of the Rao index of diversity and the Weighted Principal Coordinate Analysis. DPCoA allows comparing the partitioning of diversity at different levels of an organisational scale and the different facets of diversity (Pavoine et al., 2004, https://doi.org/10.1016/j.jtbi.2004.02.014). When the argument dis is set as NULL, the funcion calculates de Taxonomic Diversity of the sample. In contrast, when a matrix of euclidean distances is given, it calculates either the Functional Diversity (FD) or the Phylogenetic Diversity (PD) of the parasite community.

#### Case 1 sample autumn 2004
```{r}
dpcoa1TD_s2<- dpcoa(df = host1_s2, dis = NULL, scannf=T, RaoDecomp = T, full=T)
pco1TD_s2<- dudi.pco(dpcoa1TD_s2$RaoDis, scannf = F, full = T)
dpcoa1FD_s2<- dpcoa(host1_s2, traits1dist_s2, scannf=T, RaoDecomp = T, full=T)
pco1FD_s2<- dudi.pco(dpcoa1FD_s2$RaoDis, scannf = F, full = T)
dpcoa1PD_s2<- dpcoa(host1_s2, phylo1dist_s2, scannf=T, RaoDecomp = T, full=T)
pco1PD_s2<- dudi.pco(dpcoa1PD_s2$RaoDis, scannf = F, full = T)
```
We transform the α diversity values into their Equivalent Numbers (Ricotta and Szeidl, 2009, https://doi.org/10.1016/j.tpb.2009.10.001).
```{r}
alphaTD1_s2<-1/(1-dpcoa1TD_s2$RaoDiv) # Ricotta and Szeild 2009
alphaFD1_s2<-1/(1-dpcoa1FD_s2$RaoDiv) # Ricotta and Szeild 2009
alphaPD1_s2<-1/(1-dpcoa1PD_s2$RaoDiv) # Ricotta and Szeild 2009
```
##### Statistical analyses
Function lm.rrpp of package RRPP (Collyer and Adams 2018a, https://cran.r-project.org/web/packages/RRPP/index.html) performs a linear model by residual randomisation and provides empirical sampling distributions for further ANOVAs. Following Collyer and Adams (2018b, https://doi.org/10.1111/2041-210X.13029), univariate α values were log-transformed. Then, we performed ANOVAs (type I of sums of squares) using random distributions of the F-statistics (Collyer and Adams, 2018b) for TD, FD and PPD, independently. When differences between samples from different host species or localities were significant, we ran a posteriori pairwise comparisons of α TD, FD and PPD between host species or localities using function pairwise in RRPP.
* α TD
```{r}
alphaTD1_s2_st<-lm.rrpp(log(alphaTD1_s2)~h1data_s2$host.species, SS.type = "I", print.progress = F)
anova(alphaTD1_s2_st, effect.type = "F")
```
* α FD
```{r}
alphaFD1_s2_st<-lm.rrpp(log(alphaFD1_s2)~h1data_s2$host.species, SS.type = "I", print.progress = F)
anova(alphaFD1_s2_st, effect.type = "F")
```
* α PD
```{r}
alphaPD1_s2_st<-lm.rrpp(log(alphaPD1_s2)~h1data_s2$host.species, SS.type = "I", print.progress = F)
anova(alphaPD1_s2_st, effect.type = "F")
alphaPD1_s2_stpairwise<- pairwise(alphaPD1_s2_st, groups = h1data_s2$host.species)
summary(alphaPD1_s2_stpairwise, confidence = 0.95, test.type = "dist",  stat.table = FALSE) # distances between means
```

#### Case 1 sample autumn 2005
```{r}
dpcoa1TD_s4<- dpcoa(host1_s4, dis = NULL, scannf=T, RaoDecomp = T, full=T)
pco1TD_s4<- dudi.pco(dpcoa1TD_s4$RaoDis, scannf = F, full = T)
dpcoa1FD_s4<- dpcoa(host1_s4, traits1dist_s4, scannf=T, RaoDecomp = T, full=T)
pco1FD_s4<- dudi.pco(dpcoa1FD_s4$RaoDis, scannf = F, full = T)
dpcoa1PD_s4<- dpcoa(host1_s4, phylo1dist_s4, scannf=T, RaoDecomp = T, full=T)
pco1PD_s4<- dudi.pco(dpcoa1PD_s4$RaoDis, scannf = F, full = T)
```
We transform the α diversity values into their Equivalent Numbers (Ricotta and Szeidl, 2009).
```{r}
alphaTD1_s4<-1/(1-dpcoa1TD_s4$RaoDiv) # Ricotta & Szeild 2009
alphaFD1_s4<-1/(1-dpcoa1FD_s4$RaoDiv) # Ricotta & Szeild 2009
alphaPD1_s4<-1/(1-dpcoa1PD_s4$RaoDiv) # Ricotta & Szeild 2009
```
##### Satistical analyses
* α TD
```{r}
alphaTD1_s4_st<-lm.rrpp(log(alphaTD1_s4)~h1data_s4$host.species, SS.type = "I", print.progress = F)
anova(alphaTD1_s4_st, effect.type = "F")
alphaTD1_s4_stpairwise<- pairwise(alphaTD1_s4_st, groups = h1data_s4$host.species) # Pairwise distances between the parasite community of the three host species
summary(alphaTD1_s4_stpairwise, confidence = 0.95, test.type = "dist",  stat.table = FALSE) 
```
* α FD
```{r}
alphaFD1_s4_st<-lm.rrpp(log(alphaFD1_s4)~h1data_s4$host.species, SS.type = "I", print.progress = F)
anova(alphaFD1_s4_st, effect.type = "F")
alphaFD1_s4_stpairwise<- pairwise(alphaFD1_s4_st, groups = h1data_s4$host.species)
summary(alphaFD1_s4_stpairwise, confidence = 0.95, test.type = "dist",  stat.table = FALSE)
```
* α PD
```{r}
alphaPD1_s4_st<-lm.rrpp(log(alphaPD1_s4)~h1data_s4$host.species, SS.type = "I", print.progress = F)
anova(alphaPD1_s4_st, effect.type = "F")
alphaPD1_s4_stpairwise<- pairwise(alphaPD1_s4_st, groups = h1data_s4$host.species)
summary(alphaPD1_s4_stpairwise, confidence = 0.95, test.type = "dist",  stat.table = FALSE) # distances between means
```

```{r, echo=FALSE, fig.width=9, fig.cap="Figure 1. Parasite α diversity in terms of taxonomy (TD), functional traits (FD) and a proxy of the phylogeny (PPD) for each host individual of each fish species. Different lowercase letters indicate significant differences between host species"}
par (mfrow = c(2,3), cex.axis=0.8)
boxplot(alphaTD1_s2~h1data_s2$struc, col="grey",
        xlab=NULL, ylab = expression(paste(alpha, " diversity autumn 2004")),
        main="Taxonomic", frame.plot = FALSE, ylim=c(min(alphaTD1_s2), max(alphaTD1_s2)+0.3),
        xaxt='n')
text(1, 4.3, "a")
text(2, 4.3, "a")
text(3, 4.3, "a")

boxplot(alphaFD1_s2~h1data_s2$struc, col="grey",
        xlab=NULL, ylab = NULL,
        main="Functional", frame.plot = FALSE, ylim=c(min(alphaFD1_s2), max(alphaFD1_s2)+0.1),
        xaxt='n')
text(1, 1.4, "a")
text(2, 1.4, "a")
text(3, 1.4, "a")

boxplot(alphaPD1_s2~h1data_s2$struc, col="grey",
        xlab=NULL, ylab = NULL,
        main="Phylogenetic Proxy", frame.plot = FALSE, ylim=c(min(alphaPD1_s2), max(alphaPD1_s2)+0.1),
        xaxt='n')
text(1, 1.6, "a b")
text(2, 1.6, "b")
text(3, 1.6, "a")

splabels <- c(expression(italic("Chelon auratus"), italic("Mugil cephalus"), italic("Chelon ramada")))
boxplot(alphaTD1_s4~h1data_s4$struc, col="grey",
        xlab="host species", ylab = expression(paste(alpha, " diversity autumn 2005")),
        main=NULL, frame.plot = FALSE, ylim=c(min(alphaTD1_s4), max(alphaTD1_s4)+0.5),
        names= splabels
text(1, 6.6, "a")
text(2, 6.6, "a")
text(3, 6.6, "b")

boxplot(alphaFD1_s4~h1data_s4$struc, col="grey",
        xlab="host species", ylab = NULL,
        main = NULL, frame.plot = FALSE, ylim=c(min(alphaFD1_s4), max(alphaFD1_s4)+0.15),
        names= splabels
text(1, 1.4, "a")
text(2, 1.4, "a")
text(3, 1.4, "b")


boxplot(alphaPD1_s4~h1data_s4$struc, col="grey",
        xlab="host species", ylab = NULL,
        main =NULL, frame.plot = FALSE, ylim=c(min(alphaPD1_s4), max(alphaPD1_s4)+0.15),
        names= splabels
text(1, 1.6, "a")
text(2, 1.6, "b")
text(3, 1.6, "c")
```


### β diversity analyses
#### Case 1 sample autumn 2004
We calculate β1 and β2 diversities under the equivalent number approach (Ricotta and Szeidl, 2009), using the third proposition of the Rao index of diversity in Pavoine et al. (2016, https://doi.org/10.1111/2041-210X.12591) specifically developed for unbalanced samplings.
* β TD
```{r}
eqrao1TDbetas2<-EqRao(host1_s2, dis=NULL, structure = as.data.frame(h1data_s2$host.species, row.names= row.names(host1_s2)), formula="QE", option= "normed1",
                      wopt = "speciesab") # We obtain β1 and β2 diversities. normed according to de Bello et al. 2010,  https://doi.org/10.1111/j.1654-1103.2010.01195.x 
eqrao1TDbetas2
```
* β FD
```{r}
eqrao1FDbetas2<-EqRao(host1_s2, dis=traits1dist_s2, structure = as.data.frame(h1data_s2$host.species, row.names=row.names(host1_s2)), formula="QE", option= "normed1", wopt = "speciesab")

eqrao1FDbetas2
```
* β PPD
```{r}
eqrao1PDbetas2<-EqRao(host1_s2, dis=phylo1dist_s2, structure = as.data.frame(h1data_s2$host.species, row.names=row.names(host1_s2)),
                      formula="QE", option= "normed1",
                      wopt = "speciesab")

eqrao1FDbetas2
```
##### Statistical analyses
We compared each of the TD, FD and PPD β1 and β2 diversities with 999 randomly simulated β1 and β2 values in order to establish whether the observed values significantly differ from those randomly simulated (p < 0.05).

When significant, we compared observed and simulated results to determine whether the observed β1 or β2 were greater or lower than expected at random. This allows determining whether parasite communities from fish of the same species (β1) or of different fish species (β2) are more similar (the observed value is lower than simulated values) or more dissimilar (the observed value is greater than simulated values) to each other than expected by chance. Finally, we used the standardised β1 and β2 given by EqRao function (observed β – mean of randomly simulated βs/ standard deviation of randomly simulated βs) to infer if the parasite species, traits or the phylogenetic proxy are overdispersed (negative standardised β) or clustered (positive standardised β) (Head et al., 2018,  https://doi.org/10.1002/ece3.3969) within a level of a factor (β1) or between levels of a factor (β2).
* β TD
```{r}
eqrao1TDbeta1rt_s2 <- rtestEqRao(host1_s2, NULL, structure = as.data.frame(h1data_s2$host.species, row.names= row.names(host1_s2)), 
                                 formula = "QE", level=1, nrep=999, option="normed1",
                                 alter = "two-sided", wopt = "speciesab") # This is the permutation test of β1. We obtain the stadandardised observed value of β1 and a significance p.value in comparison to 999 randomly generated β1 values. alter = "two-sided" because we do not have a priori idea; wopt = "speciesab" to weight the sampling units by their sum of parasite species’ abundances

eqrao1TDbeta2rt_s2 <- rtestEqRao(host1_s2, NULL, structure = as.data.frame(h1data_s2$host.species, row.names= row.names(host1_s2)), 
                                 formula = "QE", level=2, nrep=999, option="normed1",
                                 alter = "two-sided", wopt = "speciesab") # This is the permutation test of β1. We obtain the stadandardised observed value of β2 and a significance p.value in comparison to 999 randomly generated β2 values. alter = "two-sided" because we do not have a priori idea; wopt = "speciesab" to weight the sampling units by their sum of parasite species’ abundances

eqrao1TDbeta1rt_s2
eqrao1TDbeta2rt_s2
```
* β FD
```{r}
eqrao1FDbeta1rt_s2 <- rtestEqRao(host1_s2, traits1dist_s2, structure = as.data.frame(h1data_s2$host.species, row.names=row.names(host1_s2)), 
                                 formula = "QE", level=1, nrep=999, option="normed1",
                                 alter = "two-sided", wopt = "speciesab")
eqrao1FDbeta2rt_s2 <- rtestEqRao(host1_s2, traits1dist_s2, structure = as.data.frame(h1data_s2$host.species, row.names=row.names(host1_s2)),  
                                 formula = "QE", level=2, nrep=999, option="normed1",
                                 alter = "two-sided", wopt = "speciesab")
eqrao1FDbeta1rt_s2
eqrao1FDbeta2rt_s2
```
* β PPD
```{r}
eqrao1PDbeta1rt_s2 <- rtestEqRao(host1_s2, phylo1dist_s2, structure = as.data.frame(h1data_s2$host.species, row.names=row.names(host1_s2)),  
                                 formula = "QE", level=1, nrep=999, option="normed1",
                                 alter = "two-sided", wopt = "speciesab")
eqrao1PDbeta2rt_s2 <- rtestEqRao(host1_s2, phylo1dist_s2, structure = as.data.frame(h1data_s2$host.species, row.names=row.names(host1_s2)), 
                                 formula = "QE", level=2, nrep=999, option="normed1",
                                 alter = "two-sided", wopt = "speciesab")
eqrao1PDbeta1rt_s2
eqrao1PDbeta2rt_s2
```

```{r}
ADEgS(c(plot(eqrao1TDbeta1rt_s2, main=expression(paste("Case 1, autumn 2004, TD, ",beta,"1"))),
        plot(eqrao1TDbeta2rt_s2, main=expression(paste("Case 1, autumn 2004, TD, ",beta,"2"))),
        plot(eqrao1FDbeta1rt_s2, main=expression(paste("Case 1, autumn 2004, FD, ",beta,"1"))),
        plot(eqrao1FDbeta2rt_s2, main=expression(paste("Case 1, autumn 2004, FD, ",beta,"2"))),
        plot(eqrao1PDbeta1rt_s2, main=expression(paste("Case 1, autumn 2004, PPD, ",beta,"1"))),
        plot(eqrao1PDbeta2rt_s2, main=expression(paste("Case 1, autumn 2004, PPD, ",beta,"2")))),
      layout = c(3, 2))

```
Figure 2. Observed and simulated β diversity values (Case 1: autumn 2004). (a, b, c) β1 diversity or extent of dissimilarity in the diversity of parasite communities among host individuals within each host species (_Chelon auratus_, _Mugil cephalus_ and _Chelon ramada_). (d, e, f) β2 diversity or extent of dissimilarity in the diversity of parasite communities between host species. Diversity was measured in terms of (a, d) Taxonomic Diversity (TD), (b, e) Functional Diversity (FD) and (c, f) the Proxy of Phylogenetic Diversity (PPD). Samples are from Santa Pola Lagoon and autumn 2004 (Case 1). Observed β values (black diamond on the top of the black vertical line) and distribution of the simulated (x-axis: sim) β values (grey bars).

#### Case 1 sample autumn 2005
We calculate β1 and β2 diversities under the equivalent number approach (Ricotta and Szeidl, 2009) using the third proposition of the Rao index of diversity in Pavoine et al. (2016, https://doi.org/10.1111/2041-210X.12591) since it is specifically developed for unbalanced samplings.
* β TD
```{r}
eqrao1TDbetas4<-EqRao(host1_s4, dis=NULL, structure = as.data.frame(h1data_s4$host.species, row.names=row.names(host1_s4)), formula="QE", option= "normed1",
                      wopt = "speciesab")
eqrao1TDbetas4
```
* β FD
```{r}
eqrao1FDbetas4<-EqRao(host1_s4, dis=traits1dist_s4, structure = as.data.frame(h1data_s4$host.species, row.names=row.names(host1_s4)), formula="QE", option= "normed1", wopt = "speciesab")

eqrao1FDbetas4
```
* β PPD
```{r}
eqrao1PDbetas4<-EqRao(host1_s4, dis=phylo1dist_s4, structure = as.data.frame(h1data_s4$host.species, row.names=row.names(host1_s4)), formula="QE", option= "normed1", wopt = "speciesab")

eqrao1PDbetas4
```
##### Statistical analyses
* β TD
```{r}
eqrao1TDbeta1rt_s4 <- rtestEqRao(host1_s4, NULL, structure = as.data.frame(h1data_s4$host.species, row.names=row.names(host1_s4)), 
                                 formula = "QE", level=1, nrep=999, option="normed1",
                                 alter = "two-sided", wopt = "speciesab")
eqrao1TDbeta2rt_s4 <- rtestEqRao(host1_s4, NULL, structure = as.data.frame(h1data_s4$host.species, row.names=row.names(host1_s4)), 
                                 formula = "QE", level=2, nrep=999, option="normed1",
                                 alter = "two-sided", wopt = "speciesab")

eqrao1TDbeta1rt_s4
eqrao1TDbeta2rt_s4
```
* β FD
```{r}
eqrao1FDbeta1rt_s4 <- rtestEqRao(host1_s4, traits1dist_s4, structure = as.data.frame(h1data_s4$host.species, row.names=row.names(host1_s4)), 
                                 formula = "QE", level=1, nrep=999, option="normed1",
                                 alter = "two-sided", wopt = "speciesab")
eqrao1FDbeta2rt_s4 <- rtestEqRao(host1_s4, traits1dist_s4, structure = as.data.frame(h1data_s4$host.species, row.names=row.names(host1_s4)), 
                                 formula = "QE", level=2, nrep=999, option="normed1",
                                 alter = "two-sided", wopt = "speciesab")

eqrao1FDbeta1rt_s4
eqrao1FDbeta2rt_s4
```
* β PPD
```{r}
eqrao1PDbeta1rt_s4 <- rtestEqRao(host1_s4, phylo1dist_s4, structure = as.data.frame(h1data_s4$host.species, row.names=row.names(host1_s4)), 
                                 formula = "QE", level=1, nrep=999, option="normed1",
                                 alter = "two-sided", wopt = "speciesab")
eqrao1PDbeta2rt_s4 <- rtestEqRao(host1_s4, phylo1dist_s4, structure = as.data.frame(h1data_s4$host.species, row.names=row.names(host1_s4)), 
                                 formula = "QE", level=2, nrep=999, option="normed1",
                                 alter = "two-sided", wopt = "speciesab")
eqrao1PDbeta1rt_s4
eqrao1PDbeta2rt_s4
```

```{r}
ADEgS(c(plot(eqrao1TDbeta1rt_s4, main=expression(paste("Case 1, autumn 2005, TD, ",beta,"1"))),
        plot(eqrao1TDbeta2rt_s4, main=expression(paste("Case 1, autumn 2005, TD, ",beta,"2"))),
        plot(eqrao1FDbeta1rt_s4, main=expression(paste("Case 1, autumn 2005, FD, ",beta,"1"))),
        plot(eqrao1FDbeta2rt_s4, main=expression(paste("Case 1, autumn 2005, FD, ",beta,"2"))),
        plot(eqrao1PDbeta1rt_s4, main=expression(paste("Case 1, autumn 2005, PPD, ",beta,"1"))),
        plot(eqrao1PDbeta2rt_s4, main=expression(paste("Case 1, autumn 2005, PPD, ",beta,"2")))),
      layout = c(3, 2))
```
Figure 3. Observed and simulated β diversity values (Case 1: autumn 2005). (a, b, c) β1 diversity or extent of dissimilarity in the diversity of parasite communities among host individuals within each host species (_Chelon auratus_, _Mugil cephalus_ and _Chelon ramada_). (d, e, f) β2 diversity or extent of dissimilarity in the diversity of parasite communities between host species. Diversity was measured in terms of (a, d) Taxonomic Diversity (TD), (b, e) Functional Diversity (FD) and (c, f) the Proxy of Phylogenetic Diversity (PPD). Samples are from Santa Pola Lagoon and autumn 2005 (Case 1). Observed β values (black diamond on the top of the black vertical line) and distribution of the simulated (x-axis: sim) β values (grey bars).


## Influence of two-crossed factors on diversity
To evaluate and disentangle the effect of crossed factors on diversity, we use the crossed-DPCoA (Pavoine et al., 2013, https://doi.org/10.1371/journal.pone.0054530). We analyse the effect of two-crossed factors simultaneously: host species and season. The crossed-DPCoA is grounded on the DPCoA but it analyses the effect of two-crossed factors at the same time. Thus, it distinguishes the proportional contribution of the sampling unit, each factor individually and the effect of the interaction of both factors on the diversity of the community.

### Main effect A
The crossed-DPCoA consists of three consecutive analyses. Following Pavoine et al.’s (2013) terminology, each parasite community is associated with a component of the factor A (hosts species) and a component of a factor B (season). The main version of the crossed-DPCoA plots in a DPCoA space the parasite species, the sampling units and the variables of the main factor A, without taking into account seasonal differences (factor B).

* crossed-DPCoA TD
```{r}
ab1main<- crossdpcoa_maineffect(host1, h1data$host.species, as.factor(h1data$year), dis =NULL, scannf = F)
s.label(ab1main$l2) # Positions of the levels of factor A - hosts species - on its principal axes in the main TD space
ab1main$eig[1:2]/sum(ab1main$eig) # Pertange of variation explaine by each axes: most of the variation is reflected by the first axis
(ab1main$div*100)/ab1main$div[5] # Percentage of diversity associated with each factor
# ssw: diversity within communities or percentaje of diversity due to host individual factor
# ssa: diversity related to factor A or host species;
# ssb: diversity related to factor B or season;
# ssab: diversity due to the interaction of factors or host species x season
# sst: the total diversity over all communities
```

* crossed-DPCoA FD
```{r}
ab1mainFD<- crossdpcoa_maineffect(host1, h1data$host.species, as.factor(h1data$year), dis =traits1dist, scannf = F)
s.label(ab1mainFD$l2) # Positions of the levels of factor A - hosts species - on its principal axes in the FD space
ab1mainFD$eig[1:2]/sum(ab1mainFD$eig) # Pertange of variation explaine by each axes: most of the variation is reflected by the first axis
(ab1mainFD$div*100)/ab1mainFD$div[5] # Percentage of diversity associated with each factor
```
* crossed-DPCoA PPD
```{r}
ab1mainPD<- crossdpcoa_maineffect(host1, h1data$host.species, as.factor(h1data$year), dis =phylo1dist, scannf = F)
s.label(ab1mainFD$l2) # Positions of the levels of factor A - hosts species - on its principal axes in the FD space
ab1mainPD$eig[1:2]/sum(ab1mainPD$eig) # Pertange of variation explaine by each axes
(ab1mainPD$div*100)/ab1mainPD$div[5] # Percentage of diversity associated with each factor
```


### crossed-DPCoA version 1
The first version of the crossed-DPCoA removes the amount of diversity among sampling units due to the sole effect of factor B, but retains combined effects of factors A and B (i.e. the interaction between factors A and B). This first version should always be performed to confirm that the two factors are not independent, otherwise versions 1 and 2 of the crossed-DPCoA will produce the same results. This can be done by visually comparing ellipses plots generated from version 1 and version 2.

* crossed-DPCoA TD
```{r}
a1v1 <- crossdpcoa_version1(host1, h1data$host.species, as.factor(h1data$year), dis =NULL, w = "classic", scannf = F)
s.class(a1v1$l3, h1data$host.species,  col=c("indianred", "darkgoldenrod1", "cadetblue3")) # Positions of the levels of factor A - hosts species - on its principal axes in the Version 1 TD space
```

* crossed-DPCoA FD
```{r}
a1v1FD <- crossdpcoa_version1(host1, h1data$host.species, as.factor(h1data$year), dis =traits1dist, w = "classic", scannf = F)
s.class(a1v1FD$l3, h1data$host.species,  col=c("indianred", "darkgoldenrod1", "cadetblue3")) # Positions of the levels of factor A - hosts species - on its principal axes in the Version 1 FD space
```

* crossed-DPCoA PPD
```{r}
a1v1PD <- crossdpcoa_version1(host1, h1data$host.species, as.factor(h1data$year), dis =phylo1dist, w = "classic", scannf = F)
s.class(a1v1PD$l3, h1data$host.species,  col=c("indianred", "darkgoldenrod1", "cadetblue3")) # Positions of the levels of factor A - hosts species - on its principal axes in the Version 1 PPD space
```

### crossed-DPCoA version 2

Finally, the second version of the crossed-DPCoA eliminates any influence of the factor B on the factor A (including the interaction term). Thus, it provides diversity exclusively under the light of the main crossed-factor, factor A (host species).
* crossed-DPCoA TD
```{r}
a1v2 <- crossdpcoa_version2(host1, h1data$host.species, as.factor(h1data$year), dis =NULL, w = "classic", scannf = F)
s.class(a1v2$l3, h1data$host.species,  col=c("indianred", "darkgoldenrod1", "cadetblue3")) # Positions of the levels of factor A - hosts species - on its principal axes in the Version 2 TD space
```

* crossed-DPCoA FD
```{r}
a1v2FD <- crossdpcoa_version2(host1, h1data$host.species, as.factor(h1data$year), dis =traits1dist, w = "classic", scannf = F)
s.class(a1v2FD$l3, h1data$host.species,  col=c("indianred", "darkgoldenrod1", "cadetblue3")) # Positions of the levels of factor A - hosts species - on its principal axes in the Version 2 FD space
```

* crossed-DPCoA PPD
```{r}
a1v2PD <- crossdpcoa_version2(host1, h1data$host.species, as.factor(h1data$year), dis =phylo1dist, w = "classic", scannf = F)
a1v2PD_plot<-s.class(a1v2PD$l3, h1data$host.species, col=c("indianred", "darkgoldenrod1", "cadetblue3"), plot = F, plabels.boxes.border=F) # Positions of the levels of factor A - hosts species - on its principal axes in the Version 2 PPD space
```
